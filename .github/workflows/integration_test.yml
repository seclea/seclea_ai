name: Integration Testing

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    branches: [dev]

jobs:
  test:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 12
      matrix:
        # only using ubuntu as that is the only OS that supports services. OS support should be fine from dev.
        os: [ubuntu-latest]
        python-version: [3.7] #, 3.8, 3.9, 3.10] out for testing.
        include:
          - os: ubuntu-latest
            path: ~/.cache/pip

    services:
      postgres:
        image: postgres:13.2
        env:
          POSTGRES_DB: app
          POSTGRES_USER: app_user
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432

      redis:
        image: redis
        # Set health checks to wait until redis has started
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      portal:
        image: https://052208718180.dkr.ecr.eu-west-2.amazonaws.com/seclea-portal:latest
        env:
          ENV_ROLE: production
          DEBUG: _json_'true'
          STATIC_URL: static/
          DATABASE: postgres
          SQL_DATABASE: app
          SQL_USER: app_user
          SQL_PASSWORD: postgres
          SQL_HOST: localhost
          SQL_PORT: 5432
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          VERIFY_KEY: ${{ secrets.VERIFY_KEY }}
          ALLOWED_HOSTS: _json_['"*"']
          API_URL_AUTH: http://localhost:8010
          CORS_ALLOWED_ORIGINS: _json_['"http://localhost:8080"','"http://localhost:8010"','"http://localhost:8000"']
          CORS_ALLOW_CREDENTIALS: _json_'true'
          CELERY_BROKER_URL: "redis://localhost:6379"
          CELERY_RESULT_BACKEND: "redis://localhost:6379"
          AUTH_COOKIE_SECURE: _json_'false'
          AUTH_COOKIE_HTTP_ONLY: _json_'false'
          AUTH_COOKIE_DOMAIN: ""
        ports:
          - 8000:8000

      portal-celery:
        image: https://052208718180.dkr.ecr.eu-west-2.amazonaws.com/seclea-portal-celery:latest
        env:
          ENV_ROLE: production
          DEBUG: _json_'true'
          STATIC_URL: static/
          DATABASE: postgres
          SQL_DATABASE: app
          SQL_USER: app_user
          SQL_PASSWORD: postgres
          SQL_HOST: localhost
          SQL_PORT: 5432
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          VERIFY_KEY: ${{ secrets.VERIFY_KEY }}
          ALLOWED_HOSTS: _json_['"*"']
          API_URL_AUTH: http://localhost:8010
          CORS_ALLOWED_ORIGINS: _json_['"http://localhost:8080"','"http://localhost:8010"','"http://localhost:8000"']
          CORS_ALLOW_CREDENTIALS: _json_'true'
          CELERY_BROKER_URL: "redis://localhost:6379"
          CELERY_RESULT_BACKEND: "redis://localhost:6379"
          AUTH_COOKIE_SECURE: _json_'false'
          AUTH_COOKIE_HTTP_ONLY: _json_'false'
          AUTH_COOKIE_DOMAIN: ""

      auth:
        image: https://052208718180.dkr.ecr.eu-west-2.amazonaws.com/seclea-account-management:latest
        env:
          ENV_ROLE: production
          ENVIRONMENT: account_management
          DEBUG: _json_'false'
          DATABASE: postgres
          SQL_ENGINE: django.db.backends.postgresql
          SQL_DATABASE: auth
          SQL_USER: app_user
          SQL_PASSWORD: postgres
          SQL_HOST: localhost
          SQL_PORT: 5432
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          VERIFY_KEY: ${{ secrets.VERIFY_KEY }}
          ALLOWED_HOSTS: _json_['"*"']
          API_URL: http://localhost:8010
          CORS_ALLOWED_ORIGINS: _json_['"http://localhost:8080"','"http://localhost:8010"','"http://localhost:8000"']
          CORS_ALLOW_CREDENTIALS: _json_'true'
          CELERY_BROKER_URL: "redis://localhost:6379"
          CELERY_RESULT_BACKEND: "redis://localhost:6379"
          ENABLE_PML_FILE_LOGGING: _json_'false'
          AUTH_COOKIE_SECURE: _json_'false'
          AUTH_COOKIE_HTTP_ONLY: _json_'false'
          AUTH_COOKIE_DOMAIN: ""
        ports:
          - 8010:8010

    steps:
      - name: Checkout repo - including submodules
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.TOKEN_AUTOMATION }}
          submodules: "recursive"
      - uses: actions/cache@v2
        with:
          path: ${{ matrix.path }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
      - name: Run Tests
        run: |
          python -m unittest discover test/test_integration_portal
